{% extends "layaouts/layaout.html" %}
{% block title %}Agendar cita{% endblock %}
{% block content %}
    <style>
        .calendar-cell {
            height: 60px;
            border: 1px solid #dee2e6;
            vertical-align: top;
            position: relative;
            overflow: hidden; /* Asegura que el contenido no se desborde */
        }
        
        .event {
            padding: 2px;
            margin: 1px;
            font-size: 0.8em;
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            box-sizing: border-box;
            text-align: center;
            overflow: hidden; /* Asegura que el texto no se desborde */
        }
        
        .allowed {
            background-color: #28a745;
        }
        
        .not-allowed {
            background-color: #dc3545;
        }
        
        .day-header {
            background-color: #7CFFD9 !important;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            padding: 10px;
        }
        th {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Calendario Dinámico</h1>
        <div class="row mb-3">
            <div class="col">
                <button id="prevWeek" class="btn btn-secondary">&lt; Semana anterior</button>
            </div>
            <div class="col text-center">
                <h2 id="currentWeek"></h2>
            </div>
            <div class="col text-end">
                <button id="nextWeek" class="btn btn-primary">Semana siguiente &gt;</button>
            </div>
        </div>
        <div id="calendar"></div>
    </div>

    <script>
        let currentDate = new Date();
        const maxWeeksInFuture = 3;
        const practicanteId = {{ idPrac }};  // ID del practicante que has seleccionado
        
        function getWeekDates(date) {
            const week = [];
            const current = new Date(date);
            current.setDate(current.getDate() - current.getDay() + 1); // Set to Monday
            for (let i = 0; i < 5; i++) {
                week.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return week;
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatHour(hour) {
            return `${hour.toString().padStart(2, '0')}:00`;
        }
        
        async function fetchHorarios(practicanteId) {
            try {
                const response = await fetch(`/Horario/${practicanteId}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
                return [];  // Retorna un arreglo vacío en caso de error
            }
        }
        
        async function updateCalendar() {
            const calendarEl = document.getElementById('calendar');
            const weekDates = getWeekDates(currentDate);
            const weekStart = weekDates[0];
            const weekEnd = weekDates[4];
        
            document.getElementById('currentWeek').textContent = `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
        
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr><th>Hora</th>';
            weekDates.forEach(date => {
                calendarHTML += `<th class="day-header">${date.toLocaleDateString('es-ES', { weekday: 'short' })}<br>${date.getDate()}</th>`;
            });
            calendarHTML += '</tr></thead><tbody>';
        
            const horarios = await fetchHorarios(practicanteId);
        
            for (let hour = 8; hour <= 20; hour++) {
                calendarHTML += '<tr>';
                calendarHTML += `<td>${formatHour(hour)}</td>`;
                weekDates.forEach(date => {
                    calendarHTML += '<td class="calendar-cell">';
                    const formattedHour = formatHour(hour);
                    horarios.forEach(horario => {
                        if (horario.fecha === formatDate(date) && horario.hora === formattedHour) {
                            const eventClass = horario.permitido ? 'allowed' : 'not-allowed';
                            const eventText = horario.permitido ? 'Disponible' : 'No disponible';
                            calendarHTML += `<div class="event ${eventClass}">${eventText}</div>`;
                        }
                    });
                    calendarHTML += '</td>';
                });
                calendarHTML += '</tr>';
            }
        
            calendarHTML += '</tbody></table>';
            calendarEl.innerHTML = calendarHTML;
        
            const today = new Date();
            const currentWeekStart = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            document.getElementById('prevWeek').disabled = weekStart <= currentWeekStart;
        
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + (maxWeeksInFuture * 7));
            document.getElementById('nextWeek').disabled = weekEnd >= maxDate;
        }
        
        document.getElementById('prevWeek').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 7);
            updateCalendar();
        });
        
        document.getElementById('nextWeek').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 7);
            updateCalendar();
        });
        
        updateCalendar();
        
    </script>

    {% endblock %}